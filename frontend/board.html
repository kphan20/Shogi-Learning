<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            #shogi-board { border-spacing: 0; border-collapse: collapse; margin-left: auto; margin-right: auto;}
            #shogi-board th { padding: .5em; }
            #shogi-board td { border: 1px solid; width: 4em; height: 4em; }
            td.light { background: #eee; }
            td.move-dest { background: #eee radial-gradient(rgba(20,85,30,0.5) 19%, rgba(0,0,0,0) 20%)}
        </style>
        <link rel="stylesheet" href="">
    </head>
    <body>
        <table id="shogi-board">
            <tbody>
                <tr>
                    <th>9</th>
                    <th>8</th>
                    <th>7</th>
                    <th>6</th>
                    <th>5</th>
                    <th>4</th>
                    <th>3</th>
                    <th>2</th>
                    <th>1</th>
                    <th></th>
                </tr>
                <tr>
                    <td class="light" align="center"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>1</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>2</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>3</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>4</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>5</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>6</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>7</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>8</th>
                </tr>
                <tr>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <td class="light"></td>
                    <th>9</th>
                </tr>
            </tbody>
        </table>
        
        <a href="index.html">Back to main menu</a>
        <script src="gamelogic.js"></script>
        <script src="node_modules/socket.io-client/dist/socket.io.js"></script>
        <script>
            const socket = io.connect("http://localhost:5000");

            socket.on('model move', function (move) {
                const cell = htmlBoard.rows[move[1][0] + 1].cells[move[1][1]];
                if (cell.firstChild) {
                    // logic to add captured piece to player hand
                    let capPieceType = cell.firstChild.getAttribute('class').split(' ')[PIECE_NAME];
                    capPieceType = pieceMap.indexOf(capPieceType);
                    capturedPieces[currentPlayer][capPieceType] = capturedPieces[currentPlayer][capPieceType] + 1;
                    cell.firstChild.remove();
                }
                cell.appendChild(
                    htmlBoard.rows[move[0][0] + 1].cells[move[0][1]].firstChild
                );
                currentPlayer *= -1;
            })

            socket.on('possible moves', function (moves) {
                clearDestCells();
                //const board = document.getElementById("shogi-board");
                moves.forEach((move) => {
                    const cell = htmlBoard.rows[move[1][0] + 1].cells[move[1][1]];
                    cell.classList.add('move-dest');
                    if (move[2]) cell.classList.add('promote');
                })
            });

            document.querySelectorAll('.piece').forEach((piece) => {
                piece.addEventListener("click", function (e) {
                    socket.emit("json", "hello");
                    if (piece.classList.contains(playerColorStr)) {
                        const data = {'color': playerColor, 'board': getBoard(),
                        'rank': parseInt(piece.parentElement.parentElement.rowIndex) - 1,
                        'file': parseInt(piece.parentElement.cellIndex)};
                        socket.emit("move", data);
                    }
                });
            })

            document.querySelectorAll('.light').forEach((cell) => {
                cell.addEventListener("click", () => {
                    if (!cell.classList.contains("move-dest")) return;
                    if (playerColor !== currentPlayer) return;
                    // if move-dest, then execute move
                    if (cell.firstChild) {
                        // logic to add captured piece to player hand
                        let capPieceType = cell.firstChild.getAttribute('class').split(' ')[PIECE_NAME];
                        capPieceType = pieceMap.indexOf(capPieceType);
                        capturedPieces[playerColor][capPieceType] = capturedPieces[playerColor][capPieceType] + 1;
                        cell.firstChild.remove();
                    }
                    cell.appendChild(
                        htmlBoard.rows[selectedPiece[0]].cells[selectedPiece[1]].firstChild
                    );
                    currentPlayer *= -1;
                    const data = {'board': getBoard(), 'color': currentPlayer,
                    'captured_dict': capturedPieces[currentPlayer]}
                    socket.emit("get move", data);
                });
            })
        </script>
    </body>
</html>